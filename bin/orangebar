#!/bin/bash
# Script for lemonbar on bspwm
# Updates either on recieving signal 10 sent manually (pkill -10 orangebar), when the user switches workspaces, or after 60 seconds, whichever one occurs first.

trap 'update' 10   # allows user to instantaneously update the bar

fifo=${XDG_RUNTIME_DIR:-/tmp}/lemonbar.fifo
test -e $fifo && rm $fifo
mkfifo $fifo

fgb='%{F#937f74}'
fgn='%{F#bebebe}'
fga='%{F#8b8f7e}'
fga2='%{F#987a6b}'

clock() {
	date "+%a, %b %d  ~  %I:%M %p"
}

net() {
        con_up="$(nmcli --terse --fields NAME,TYPE,DEVICE con show --active | grep -v 'virbr0')"

        if [[ "$con_up" == *"ethernet"* ]]; then
#                netp="$(echo "$con_up" | grep 'ethernet' | awk -F: '{print $3}' | cut -c1-3)"
                net="$(echo "$con_up" | grep 'ethernet' | awk -F: '{print $1}')"
        fi
        
        if [[ "$con_up" == *"wireless"* ]]; then
 #               netp="$(echo "$con_up" | grep 'wireless' | awk -F: '{print $3}' | cut -c1-3)"
                net="$(echo "$con_up" | grep 'wireless' | awk -F: '{print $1}')"
        fi
        
        if [[ "$con_up" != *"ethernet"* && "$con_up" != *"wireless"* ]]; then
  #              netp="Airplane mode"
  		 net="Airplane mode"
        fi
        
        if [[ "$con_up" == *"tun"* || "$con_up" == *"vpn"* ]];then
                #vpn=""
		vpn="${fga}(vpn)"
        fi
}

vol() {
        pacmd list-sinks|grep -A 15 '* index'| awk '/volume: front/{ print $5 }' | sed 's/%//g'
}

bat() {
        bat=$(cat /sys/class/power_supply/BAT0/capacity)%
        bat_state="$(upower -i /org/freedesktop/UPower/devices/battery_BAT0 | grep state | tr -d "[:space:]" | cut -c 7-)"
        if [ "$bat_state" = "charging" ]; then
#                bat="$bat "
                 bat="$bat ${fga}(charging)"
        fi
        echo "$bat"
}

cmus-info() {
	if pgrep cmus >/dev/null 2>&1 ; then
		title="$(cmus-remote -Q | grep "tag title " | sed "s/tag title //")"	
		album="$(cmus-remote -Q | grep "tag album " | sed "s/tag album //")"
		artist="$(cmus-remote -Q | grep "tag artist " | sed "s/tag artist //")"
		echo "${fgb}playing: ${fgn}$title ${fgb}~ ${fga}$album ${fgb}by ${fgb}$artist"
	fi
}

update() {
	echo "%{l}%{O5}${fgn} $(bspc query -D -d focused --names) %{O20}$(cmus-info) %{c}${fgn}$(clock) %{r}${fga2}vol ~ ${fgn}$(vol)% ${fga} \  ${fgb}net ~ ${fgn}$net ${vpn} ${fga} \  ${fgb}bat ~ ${fgn}$(bat)%{O10}"
	while read -r line; do
		echo "%{l}%{O5}${fgn} $(bspc query -D -d focused --names) %{O20}$(cmus-info) %{c}${fgn}$(clock) %{r}${fga2}vol ~ ${fgn}$(vol)% ${fga} \  ${fgb}net ~ ${fgn}$net ${vpn} ${fga} \  ${fgb}bat ~ ${fgn}$(bat)%{O10}"
	done < <(bspc subscribe desktop) &
}

while :;
do
	net
	update
	sleep 60 &
	wait
done
